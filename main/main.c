/* Hello World Example

   This example code is in the Public Domain (or CC0 licensed, at your option.)

   Unless required by applicable law or agreed to in writing, this
   software is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR
   CONDITIONS OF ANY KIND, either express or implied.
*/
#include <stdio.h>
#include "freertos/FreeRTOS.h"
#include "freertos/task.h"

#include "esp_system.h"
#include "nvs_flash.h"

#include <string.h>
#include "constants.h"
#include "pow.h"
#include "curl/curl.h"

const char* tx = "999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999A9RGRKVGWMWMKOLVMDFWJUHNUNYWZTJADGGPZGXNLERLXYWJE9WQHWWBMCPZMVVMJUMWWBLZLNMLDCGDJ999999999999999999999999999999999999999999999999999999YGYQIVD99999999999999999999TXEFLKNPJRBYZPORHZU9CEMFIFVVQBUSTDGSJCZMBTZCDTTJVUFPTCCVHHORPMGCURKTH9VGJIXUQJVHK999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999";

const char* TryteAlphabet = TryteAlphabetCorpus;

static trit_t tryteToTritsMapping[27][3] = {
  {0, 0, 0}, {1, 0, 0}, {-1, 1, 0}, {0, 1, 0},
  {1, 1, 0}, {-1, -1, 1}, {0, -1, 1}, {1, -1, 1},
  {-1, 0, 1}, {0, 0, 1}, {1, 0, 1}, {-1, 1, 1},
  {0, 1, 1}, {1, 1, 1}, {-1, -1, -1}, {0, -1, -1},
  {1, -1, -1}, {-1, 0, -1}, {0, 0, -1}, {1, 0, -1},
  {-1, 1, -1}, {0, 1, -1}, {1, 1, -1}, {-1, -1, 0},
  {0, -1, 0}, {1, -1, 0}, {-1, 0, 0},
};


char* trytes(trit_t* t) {
  int i = 0;
  size_t length = HashSize/3;
  char* o = malloc(length + 1);
  memset(o, 0, length + 1);

  for(i = 0; i < length; i++) {
    int8_t j = t[i*3] + t[i*3+1]*3 + t[i*3+2]*9;
    if(j < 0) {
      j += TryteAlphabetLength;
    }
    o[i] = TryteAlphabet[j];
  }

  return o;
}

trit_t* trytes_toTrits(const char* t) {
  int i = 0;
  size_t len = strlen(t);
  trit_t* trits = malloc(len*3);
  for(i = 0; i<len; i++ ){
    size_t idx = 0;
    char c = t[i];
    if(c != '9') {
      idx = c - 64;
    }

    memcpy(trits + i*3*sizeof(trit_t), tryteToTritsMapping[idx], 3);
  }

  return trits;
}

void powC() {
  int mwm = 15;
  int n = 0;

  Curl* ctx = malloc(sizeof(Curl)); 
  init_curl(ctx);
  
  trit_t* tr = trytes_toTrits(tx);
  absorb(ctx, tr, 0, sizeof(trit_t)*(transactionTrinarySize - HashSize));

  memcpy(ctx->state, tr + (transactionTrinarySize - HashSize), HashSize*sizeof(trit_t));

  char* result = NULL;
  {
    trit_t* nonce = malloc(HashSize);
    memset(nonce, 0, HashSize*sizeof(trit_t));

    int64_t r = pwork(ctx->state, mwm, nonce, n);

    printf("nonce ");
    for(int i = 0; i < HashSize; i++) {
      printf("%d ", nonce[i]);
    }
    printf("\n");

    result = trytes(nonce); 

    //free(nonce);
  }

  //free(ctx);
  //free(tr);

  printf("result: %s\n", result);
}


void iota32_task(void *pvParameter)
{
    printf("Hello world!\n");

    TickType_t xTime = xTaskGetTickCount();
    powC();

    xTime = xTaskGetTickCount() - xTime;
    printf("time elapsed: %d\n", xTime);
    for (int i = 15; i >= 0; i--) {
        printf("Restarting in %d seconds...\n", i);
        vTaskDelay(100000000 / portTICK_PERIOD_MS);
    }
    fflush(stdout);
    esp_restart();
}

void app_main()
{
    nvs_flash_init();
    xTaskCreate(&iota32_task, "iota32", 102400, NULL, 5, NULL);
}
